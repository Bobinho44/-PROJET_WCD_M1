<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScoreEndpoint.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WebAndCloud</a> &gt; <a href="index.source.html" class="el_package">foo</a> &gt; <span class="el_source">ScoreEndpoint.java</span></div><h1>ScoreEndpoint.java</h1><pre class="source lang-java linenums">package foo;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
import java.util.Optional;
import java.util.Random;
import java.util.stream.Collectors;

import com.google.api.server.spi.auth.common.User;
import com.google.api.server.spi.config.Api;
import com.google.api.server.spi.config.ApiMethod;
import com.google.api.server.spi.config.ApiMethod.HttpMethod;
import com.google.api.server.spi.config.ApiNamespace;
import com.google.api.server.spi.response.UnauthorizedException;

import com.google.appengine.api.datastore.Cursor;
import com.google.appengine.api.datastore.DatastoreService;
import com.google.appengine.api.datastore.DatastoreServiceFactory;
import com.google.appengine.api.datastore.Entity;
import com.google.appengine.api.datastore.EntityNotFoundException;
import com.google.appengine.api.datastore.FetchOptions;
import com.google.appengine.api.datastore.Key;
import com.google.appengine.api.datastore.KeyFactory;
import com.google.appengine.api.datastore.Query;
import com.google.appengine.api.datastore.PreparedQuery;
import com.google.appengine.api.datastore.Query.FilterOperator;
import com.google.appengine.api.datastore.Query.FilterPredicate;
import com.google.appengine.api.datastore.Transaction;

@Api(name = &quot;myApi&quot;,
     version = &quot;v1&quot;,
     audiences = &quot;198559984912-f0hq5dtmguc10ta2lrfrfhlmmtgdg805.apps.googleusercontent.com&quot;,
  	 clientIds = {&quot;198559984912-f0hq5dtmguc10ta2lrfrfhlmmtgdg805.apps.googleusercontent.com&quot;,
        &quot;927375242383-jm45ei76rdsfv7tmjv58tcsjjpvgkdje.apps.googleusercontent.com&quot;},
     namespace =
     @ApiNamespace(
		   ownerDomain = &quot;wcd-cloud-datastore-projet.appspot.com&quot;,
		   ownerName = &quot;wcd-cloud-datastore-projet.appspot.com&quot;,
		   packagePath = &quot;&quot;)
     )

<span class="nc" id="L44">public class ScoreEndpoint {</span>

    @ApiMethod(name = &quot;likePost&quot;, httpMethod = HttpMethod.POST)
	public void likePost(User user, TinyLikeInfo likeInfo) throws UnauthorizedException, EntityNotFoundException {
		
        //Checks if the user is registered
<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L51">			throw new UnauthorizedException(&quot;Invalid credentials&quot;);</span>
        }

<span class="nc" id="L54">        DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();</span>

        //Gets the post to like
<span class="nc" id="L57">        Entity tinyPost = datastore.get(KeyFactory.createKey(&quot;Post&quot;, likeInfo.id));</span>

        //Creates the like index
<span class="nc" id="L60">        Entity tinyLikeIndex = new Entity(&quot;LikeIndex&quot;, user.getId() + &quot;/&quot; + likeInfo.id);</span>
<span class="nc" id="L61">        tinyLikeIndex.setProperty(&quot;post&quot;, tinyPost.getKey());</span>
<span class="nc" id="L62">        tinyLikeIndex.setProperty(&quot;liker&quot;, user.getId());</span>
<span class="nc" id="L63">        datastore.put(tinyLikeIndex);</span>

        //Gets all like counter associated with the post
<span class="nc" id="L66">        Query q = new Query(&quot;LikeCounter&quot;).setFilter(new FilterPredicate(&quot;post&quot;, FilterOperator.EQUAL, tinyPost.getKey()));</span>
<span class="nc" id="L67">        List&lt;Entity&gt; counters = datastore.prepare(q).asList(FetchOptions.Builder.withLimit(40000));</span>

<span class="nc" id="L69">        boolean liked = false;</span>

        //Likes the post
<span class="nc bnc" id="L72" title="All 2 branches missed.">        while (!liked) {</span>

            //Selects a random counter
<span class="nc" id="L75">            Entity tinyLikeCounter = counters.get(new Random().nextInt(counters.size()));</span>

            //Starts transaction
<span class="nc" id="L78">            Transaction transaction = datastore.beginTransaction();</span>

<span class="nc" id="L80">            long likes = (long) tinyLikeCounter.getProperty(&quot;likes&quot;);</span>
<span class="nc" id="L81">            tinyLikeCounter.setProperty(&quot;likes&quot;, likes + 1);</span>
<span class="nc" id="L82">            datastore.put(tinyLikeCounter);</span>

<span class="nc" id="L84">            transaction.commit();</span>

            //Checks if the transaction has been commited
<span class="nc bnc" id="L87" title="All 2 branches missed.">            if (transaction.isActive()) {</span>
<span class="nc" id="L88">                transaction.rollback();</span>

                //Checks if the counter limit hasn't be reached
<span class="nc bnc" id="L91" title="All 2 branches missed.">                if (counters.size() &lt; 40000) {</span>

                    //Creates a new like counter
<span class="nc" id="L94">                    Entity newTinyLikeCounter = new Entity(&quot;LikeCounter&quot;, tinyPost.getKey() + &quot;/&quot; + user.getId());</span>
<span class="nc" id="L95">                    newTinyLikeCounter.setProperty(&quot;post&quot;, tinyPost.getKey());</span>
<span class="nc" id="L96">                    newTinyLikeCounter.setProperty(&quot;likes&quot;, 1L);</span>
<span class="nc" id="L97">                    datastore.put(newTinyLikeCounter);</span>
<span class="nc" id="L98">                    liked = true;</span>
<span class="nc" id="L99">                }</span>
            }

            //The transaction has been commited
            else {
<span class="nc" id="L104">                liked = true;</span>
            }
<span class="nc" id="L106">        }</span>
<span class="nc" id="L107">    }</span>

    private long getLikes(User user, Entity post) throws UnauthorizedException {
<span class="nc" id="L110">        DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();</span>

        //Gets all like counter of a post
<span class="nc" id="L113">        Query q = new Query(&quot;LikeCounter&quot;).setFilter(new FilterPredicate(&quot;post&quot;, FilterOperator.EQUAL, post.getKey()));</span>

        //Gets the number of like of a post
<span class="nc" id="L116">        return datastore.prepare(q).asList(FetchOptions.Builder.withLimit(40000)).stream()</span>
<span class="nc" id="L117">            .mapToLong(counter -&gt; (long) counter.getProperty(&quot;likes&quot;))</span>
<span class="nc" id="L118">            .sum();</span>
    }

    private boolean hasLiked(String liker, long post) throws UnauthorizedException {
<span class="nc" id="L122">        DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();</span>

        //Checks if a LikeIndex has the key &quot;liker/post&quot;
        try {
<span class="nc" id="L126">            datastore.get(KeyFactory.createKey(&quot;LikeIndex&quot;, liker + &quot;/&quot; + post));</span>
<span class="nc" id="L127">            return true;</span>
        }
<span class="nc" id="L129">        catch (EntityNotFoundException e) {</span>
<span class="nc" id="L130">            return false;</span>
        }

    }

    @ApiMethod(name = &quot;createPost&quot;, httpMethod = HttpMethod.POST)
	public void createPost(User user, TinyPostInfo postInfo) throws UnauthorizedException, EntityNotFoundException {
		
        //Checks if the user is registered
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L140">			throw new UnauthorizedException(&quot;Invalid credentials&quot;);</span>
        }

<span class="nc" id="L143">        DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();</span>

        //Creates the post
<span class="nc" id="L146">        Entity tinyPost = new Entity(&quot;Post&quot;);</span>
<span class="nc" id="L147">        tinyPost.setProperty(&quot;url&quot;, postInfo.url);</span>
<span class="nc" id="L148">        tinyPost.setProperty(&quot;sender&quot;,  user.getId());</span>
<span class="nc" id="L149">        datastore.put(tinyPost);</span>

        //Creates the like counter
<span class="nc" id="L152">        Entity tinyLikeCounter = new Entity(&quot;LikeCounter&quot;, tinyPost.getKey() + &quot;/initialCounter&quot;);</span>
<span class="nc" id="L153">        tinyLikeCounter.setProperty(&quot;post&quot;, tinyPost.getKey());</span>
<span class="nc" id="L154">        tinyLikeCounter.setProperty(&quot;likes&quot;, 0L);</span>
<span class="nc" id="L155">        datastore.put(tinyLikeCounter);</span>

        List&lt;String&gt; followers;
<span class="nc" id="L158">        int followersNumber = 1;</span>
<span class="nc" id="L159">        long postDate = new Date().getTime();</span>
        //Optional&lt;Cursor&gt; cursor = Optional.empty();

        //Gets all user followers and create post index
<span class="nc bnc" id="L163" title="All 2 branches missed.">        while (followersNumber &gt;= 1) {</span>
<span class="nc" id="L164">            Query q = new Query(&quot;FollowIndex&quot;).setFilter(new FilterPredicate(&quot;followed&quot;, FilterOperator.EQUAL, user.getId()));</span>

<span class="nc" id="L166">            PreparedQuery pq = datastore.prepare(q);</span>

            /**QueryResultList&lt;Entity&gt; result = cursor.map(c -&gt; pq.asQueryResultList(FetchOptions.Builder.withLimit(40000).startCursor(c))).orElse(pq.asQueryResultList(FetchOptions.Builder.withLimit(40000)));

            cursor = Optional.of(result.getCursor());

            followers = result.stream()
                .map(follower -&gt; (String) follower.getProperty(&quot;follower&quot;))
                .collect(Collectors.toList());

            followersNumber = result.size();*/

<span class="nc" id="L178">            followers = pq.asList(FetchOptions.Builder.withLimit(40000)).stream()</span>
<span class="nc" id="L179">                .map(follower -&gt; (String) follower.getProperty(&quot;follower&quot;))</span>
<span class="nc" id="L180">                .collect(Collectors.toList());</span>

<span class="nc" id="L182">            followersNumber = 0;</span>

            //Creates the postIndex
<span class="nc" id="L185">            Entity tinyPostIndex = new Entity(&quot;PostIndex&quot;, Long.MAX_VALUE - postDate + &quot;/&quot; + user.getId());</span>
<span class="nc" id="L186">            tinyPostIndex.setProperty(&quot;post&quot;, tinyPost.getKey());</span>
<span class="nc" id="L187">            tinyPostIndex.setProperty(&quot;followers&quot;, new ArrayList&lt;&gt;(followers));</span>
<span class="nc" id="L188">            datastore.put(tinyPostIndex);</span>
<span class="nc" id="L189">        }</span>
<span class="nc" id="L190">    }</span>

    //TODO getPosts
    @ApiMethod(name = &quot;abcd&quot;, httpMethod = HttpMethod.GET)
	public List&lt;Entity&gt; abcd(User user) throws UnauthorizedException {

        //Checks if the user is registered
<span class="nc bnc" id="L197" title="All 2 branches missed.">		if (user == null) {</span>
<span class="nc" id="L198">			throw new UnauthorizedException(&quot;Invalid credentials&quot;);</span>
        }

<span class="nc" id="L201">        DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();</span>

        //Gets all post index where the user is a follower of the sender
<span class="nc" id="L204">        Query q = new Query(&quot;PostIndex&quot;).setFilter(new FilterPredicate(&quot;followers&quot;, FilterOperator.EQUAL, user.getId()));</span>
    
        //Gets all post where the user is a follower of the sender
<span class="nc" id="L207">        return datastore.prepare(q).asList(FetchOptions.Builder.withLimit(10)).stream()</span>
<span class="nc" id="L208">            .map(postIndex -&gt;  {</span>
                try {
<span class="nc" id="L210">                    Entity searchedPost = datastore.get((Key) postIndex.getProperty(&quot;post&quot;));</span>
                    
                    //Creates the post informations
<span class="nc" id="L213">                    Entity e = new Entity(&quot;SearchedPost&quot;);</span>
<span class="nc" id="L214">                    e.setProperty(&quot;id&quot;, searchedPost.getKey().getId());</span>
<span class="nc" id="L215">                    e.setProperty(&quot;sender&quot;, datastore.get(KeyFactory.createKey(&quot;User&quot;, (String) searchedPost.getProperty(&quot;sender&quot;))).getProperty(&quot;fullName&quot;));</span>
<span class="nc" id="L216">                    e.setProperty(&quot;url&quot;, searchedPost.getProperty(&quot;url&quot;));</span>
<span class="nc" id="L217">                    e.setProperty(&quot;likes&quot;, getLikes(user, searchedPost));</span>
<span class="nc" id="L218">                    e.setProperty(&quot;hasLiked&quot;, hasLiked(user.getId(), ((Key) postIndex.getProperty(&quot;post&quot;)).getId()));</span>
        
<span class="nc" id="L220">                    return e;</span>
<span class="nc" id="L221">                } catch (EntityNotFoundException | UnauthorizedException e) {</span>
<span class="nc" id="L222">                    return null;</span>
                }
            })
<span class="nc" id="L225">            .collect(Collectors.toList());</span>
    }

    @ApiMethod(name = &quot;registerUser&quot;, httpMethod = HttpMethod.POST)
	public void registerUser(User user, TinyUserInfo userInfo) throws UnauthorizedException {

        //Checks if the user is registered
<span class="nc bnc" id="L232" title="All 2 branches missed.">		if (user == null) {</span>
<span class="nc" id="L233">			throw new UnauthorizedException(&quot;Invalid credentials&quot;);</span>
        }

<span class="nc" id="L236">        DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();</span>

        //Creates the user
<span class="nc" id="L239">        Entity tinyUser = new Entity(&quot;User&quot;, user.getId());</span>
<span class="nc" id="L240">        tinyUser.setProperty(&quot;fullName&quot;, userInfo.name);</span>
<span class="nc" id="L241">        tinyUser.setProperty(&quot;name&quot;, userInfo.name.toLowerCase());</span>
<span class="nc" id="L242">        tinyUser.setProperty(&quot;picture&quot;, userInfo.picture);</span>
<span class="nc" id="L243">        datastore.put(tinyUser);</span>

        //Creates the follow index
<span class="nc" id="L246">        Entity tinyFollowIndex = new Entity(&quot;FollowIndex&quot;, user.getId() + &quot;/&quot; + user.getId());</span>
<span class="nc" id="L247">        tinyFollowIndex.setProperty(&quot;follower&quot;, user.getId());</span>
<span class="nc" id="L248">        tinyFollowIndex.setProperty(&quot;followed&quot;, user.getId());</span>
<span class="nc" id="L249">        datastore.put(tinyFollowIndex);</span>
<span class="nc" id="L250">    }</span>

    @ApiMethod(name = &quot;searchUsers&quot;, httpMethod = HttpMethod.GET)
	public List&lt;Entity&gt; searchUsers(User user, TinySearchUserInfo searchUserInfo) throws UnauthorizedException {
		
        //Checks if the user is registered
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L257">			throw new UnauthorizedException(&quot;Invalid credentials&quot;);</span>
        }

<span class="nc" id="L260">        DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();</span>

        //Checks if the reasearch is not empty
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (searchUserInfo.name.equals(&quot;&quot;)) {</span>
<span class="nc" id="L264">            return Collections.emptyList();</span>
        }
        
        //Gets all user with a name greater than the reasearched name (lexicographical order)
<span class="nc" id="L268">		Query q = new Query(&quot;User&quot;).setFilter(new FilterPredicate(&quot;name&quot;, FilterOperator.GREATER_THAN_OR_EQUAL, searchUserInfo.name));</span>

		//Gets all user compatible with the research
<span class="nc" id="L271">        return datastore.prepare(q).asList(FetchOptions.Builder.withLimit(10)).stream()</span>
<span class="nc" id="L272">            .map(searchedUser -&gt; {</span>

                //Creates the user informations
<span class="nc" id="L275">                Entity e = new Entity(&quot;SearchedUser&quot;);</span>
<span class="nc" id="L276">                e.setProperty(&quot;id&quot;, searchedUser.getKey().getName());</span>
<span class="nc" id="L277">                e.setProperty(&quot;name&quot;, searchedUser.getProperty(&quot;name&quot;));</span>
<span class="nc" id="L278">                e.setProperty(&quot;picture&quot;, searchedUser.getProperty(&quot;picture&quot;));</span>
<span class="nc" id="L279">                e.setProperty(&quot;isFollower&quot;, isFollower(user.getId(), searchedUser.getKey().getName()));</span>

<span class="nc" id="L281">                return e;</span>
<span class="nc" id="L282">            }).collect(Collectors.toList());</span>
	}
    
    @ApiMethod(name = &quot;followUser&quot;, httpMethod = HttpMethod.POST)
	public void followUser(User user, TinyFollowInfo followInfo) throws UnauthorizedException {

        //Checks if the user is registered
<span class="nc bnc" id="L289" title="All 2 branches missed.">		if (user == null) {</span>
<span class="nc" id="L290">			throw new UnauthorizedException(&quot;Invalid credentials&quot;);</span>
        }

<span class="nc" id="L293">        DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();</span>

        //Creates the follow index
<span class="nc" id="L296">        Entity tinyFollowIndex = new Entity(&quot;FollowIndex&quot;, user.getId() + &quot;/&quot; + followInfo.id);</span>
<span class="nc" id="L297">        tinyFollowIndex.setProperty(&quot;follower&quot;, user.getId());</span>
<span class="nc" id="L298">        tinyFollowIndex.setProperty(&quot;followed&quot;, followInfo.id);</span>
<span class="nc" id="L299">        datastore.put(tinyFollowIndex);</span>
<span class="nc" id="L300">    }</span>

    private boolean isFollower(String follower, String followed) {
<span class="nc" id="L303">        DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();</span>

        //Checks if a followIndex has the key &quot;follower/followed&quot;
        try {
<span class="nc" id="L307">            datastore.get(KeyFactory.createKey(&quot;FollowIndex&quot;, follower + &quot;/&quot; + followed));</span>
<span class="nc" id="L308">            return true;</span>
        }
<span class="nc" id="L310">        catch (EntityNotFoundException e) {</span>
<span class="nc" id="L311">            return false;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>